# 开发设计：core-image-composite

## 合成图布局

### 合成图示例

```
┌────────────────────────────────────────────────────────────┐
│ [1]                                                        │
│ ┌────────────────────────────────────────────────────────┐ │
│ │                                                        │ │
│ │                    截图1 (原尺寸)                      │ │
│ │                                                        │ │
│ └────────────────────────────────────────────────────────┘ │
│ 用户对截图1的意见说明文字                                   │
│ 可以是多行...                                               │
├────────────────────────────────────────────────────────────┤
│ [2]                                                        │
│ 这是一条纯文本条目（无图片）                                │
│ 用于自发的思考和要求，不对应特定截图                        │
├────────────────────────────────────────────────────────────┤
│ [3]                                                        │
│ ┌──────────────────────────┐                               │
│ │                          │                               │
│ │    截图2 (原尺寸，窄)    │                               │
│ │                          │                               │
│ └──────────────────────────┘                               │
│ 用户对截图2的意见                                           │
└────────────────────────────────────────────────────────────┘
```

### 布局规则

1. **垂直堆叠**：每个条目从上到下排列
2. **图片保持原尺寸**：不缩放
3. **画布宽度** = max(所有图片宽度, 最小宽度)
4. **图文紧邻**：文字说明直接放在图片下方
5. **条目分隔**：用分隔线区分
6. **统一编号**：图片条目和纯文本条目统一编号
7. **只合成勾选的条目**：保持原编号（避免文本中的编号引用错乱）

## 接口设计

### CompositeService

```csharp
public class CompositeService
{
    /// <summary>
    /// 合成多个截图条目为一张大图
    /// </summary>
    /// <param name="entries">截图条目列表（只包含勾选的）</param>
    /// <param name="options">合成选项</param>
    /// <returns>合成后的图片</returns>
    public Bitmap Composite(IList<ScreenshotEntry> entries, CompositeOptions options = null);
    
    /// <summary>
    /// 复制图片到剪贴板
    /// </summary>
    public void CopyToClipboard(Bitmap image);
}

public class CompositeOptions
{
    public int MaxWidth { get; set; } = 2000;
    public int Padding { get; set; } = 20;
    public Font NumberFont { get; set; }
    public Font TextFont { get; set; }
}
```

## 布局算法

```
输入：entries（勾选的条目列表）
输出：合成图

算法：
1. 计算画布宽度 = max(所有图片宽度) + padding * 2
2. 初始化 currentY = padding
3. 对于每个条目 entry：
   a. 绘制编号 [entry.Index]
   b. 如果是图片条目：
      - 绘制图片（带标注）
      - currentY += 图片高度
   c. 绘制文本（自动换行）
   d. currentY += 文本高度 + padding
   e. 绘制分隔线
4. 裁剪到实际内容高度
5. 返回合成图
```

## 设计决策

1. **保持原编号** — 合成时使用条目的原始编号，避免用户文本中的引用失效
2. **图片原尺寸** — 不缩放，保证清晰度
3. **文字自动换行** — 根据画布宽度自动换行
4. **白色背景** — 简洁清晰
