# 开发设计：core-history

## 功能说明

保存每次合成的大图和元数据，便于用户回顾和复用历史结果。

## 存储结构

```
%LOCALAPPDATA%\BatchNote\
├── config.json                  # 配置文件
└── history\                     # 历史记录
    ├── 2025-12-17_103045.png    # 合成图
    ├── 2025-12-17_103045.json   # 元数据
    ├── 2025-12-17_112233.png
    ├── 2025-12-17_112233.json
    └── ...
```

### 元数据格式

```json
{
    "timestamp": "2025-12-17T10:30:45",
    "entries": [
        {
            "index": 1,
            "hasImage": true,
            "comment": "这里有问题"
        },
        {
            "index": 2,
            "hasImage": false,
            "comment": "请解释这段代码"
        }
    ]
}
```

## 接口设计

### HistoryService

```csharp
public class HistoryService
{
    /// <summary>
    /// 保存历史记录
    /// </summary>
    /// <param name="image">合成图</param>
    /// <param name="entries">条目列表</param>
    /// <returns>记录ID（时间戳）</returns>
    public string SaveHistory(Bitmap image, IList<ScreenshotEntry> entries);
    
    /// <summary>
    /// 获取历史记录列表
    /// </summary>
    /// <returns>按时间倒序排列</returns>
    public List<HistoryRecord> GetHistoryList();
    
    /// <summary>
    /// 加载历史图片
    /// </summary>
    public Bitmap LoadHistoryImage(string id);
    
    /// <summary>
    /// 删除历史记录
    /// </summary>
    public void DeleteHistory(string id);
    
    /// <summary>
    /// 清理旧记录（保留最近 N 条）
    /// </summary>
    public void CleanupOldRecords(int keepCount);
}

public class HistoryRecord
{
    public string Id { get; set; }           // 时间戳ID
    public DateTime Timestamp { get; set; }
    public string ThumbnailPath { get; set; }
    public int EntryCount { get; set; }
}
```

### HistoryForm（历史窗口）

```csharp
public class HistoryForm : Form
{
    // 显示历史列表
    // 点击预览
    // 复制到剪贴板
    // 删除记录
}
```

## UI 设计

### 历史窗口布局

```
┌─────────────────────────────────────────────────────────────┐
│  历史记录                                         [×]       │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  ┌──────────┐  2025-12-17 10:30:45                         │
│  │ 缩略图   │  3 个条目                                     │
│  │          │  [预览] [复制] [删除]                         │
│  └──────────┘                                               │
│                                                             │
│  ┌──────────┐  2025-12-17 09:15:22                         │
│  │ 缩略图   │  5 个条目                                     │
│  │          │  [预览] [复制] [删除]                         │
│  └──────────┘                                               │
│                                                             │
│  （更多历史...可滚动）                                       │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

## 设计决策

1. **本地存储** — 使用 %LOCALAPPDATA%，不需要管理员权限
2. **自动清理** — 超过 N 条（默认50）自动删除最旧记录
3. **缩略图** — 列表显示缩略图，点击预览原图
4. **合成时自动保存** — 每次合成自动保存到历史
