# 开发设计：core-hotkey

## 功能说明

全局热键服务，用于在任何应用中呼出/隐藏 BatchNote 窗口。

## 接口设计

### HotkeyService

```csharp
public class HotkeyService : IDisposable
{
    /// <summary>
    /// 热键按下事件
    /// </summary>
    public event EventHandler HotkeyPressed;
    
    /// <summary>
    /// 注册全局热键
    /// </summary>
    /// <param name="windowHandle">窗口句柄（用于接收消息）</param>
    /// <param name="id">热键ID</param>
    /// <param name="key">按键</param>
    /// <param name="modifiers">修饰键</param>
    /// <returns>是否注册成功</returns>
    public bool Register(IntPtr windowHandle, int id, Keys key, KeyModifiers modifiers);
    
    /// <summary>
    /// 注销热键
    /// </summary>
    public bool Unregister(IntPtr windowHandle, int id);
    
    /// <summary>
    /// 处理 WM_HOTKEY 消息
    /// </summary>
    public void ProcessHotkey(Message m);
}

[Flags]
public enum KeyModifiers
{
    None = 0,
    Alt = 1,
    Control = 2,
    Shift = 4,
    Win = 8
}
```

### Win32Api 封装

```csharp
public static class Win32Api
{
    public const int WM_HOTKEY = 0x0312;
    
    [DllImport("user32.dll")]
    public static extern bool RegisterHotKey(IntPtr hWnd, int id, uint fsModifiers, uint vk);
    
    [DllImport("user32.dll")]
    public static extern bool UnregisterHotKey(IntPtr hWnd, int id);
}
```

## 使用方式

```csharp
// 在 MainForm 中
private HotkeyService _hotkeyService;

protected override void OnLoad(EventArgs e)
{
    _hotkeyService = new HotkeyService();
    _hotkeyService.HotkeyPressed += OnHotkeyPressed;
    
    // 注册 Ctrl+Shift+B
    _hotkeyService.Register(this.Handle, 1, Keys.B, 
        KeyModifiers.Control | KeyModifiers.Shift);
}

protected override void WndProc(ref Message m)
{
    if (m.Msg == Win32Api.WM_HOTKEY)
    {
        _hotkeyService.ProcessHotkey(m);
    }
    base.WndProc(ref m);
}

private void OnHotkeyPressed(object sender, EventArgs e)
{
    if (this.Visible)
        this.Hide();
    else
        this.Show();
}
```

## 设计决策

1. **默认热键 Ctrl+Shift+B** — B = BatchNote，易记
2. **热键冲突处理** — 注册失败时提示用户
3. **窗口句柄绑定** — 热键消息发送到指定窗口
