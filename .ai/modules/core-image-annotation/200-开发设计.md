# 开发设计：core-image-annotation

## UI 设计

### 预览窗口布局

```
鼠标悬浮在缩略图上时弹出：

┌─────────────────────────────────────────┐
│           原图预览（可滚动）             │
│  ┌─────────────────────────────────┐   │
│  │                                 │   │
│  │    (原始尺寸图片)               │   │
│  │                                 │   │
│  │    ╭─────╮  ← 用户画的标注      │   │
│  │    │问题 │                      │   │
│  │    ╰─────╯                      │   │
│  │                                 │   │
│  └─────────────────────────────────┘   │
│                                         │
│  [撤销] [清除标注]                       │
└─────────────────────────────────────────┘

- 鼠标在图片上时变为画笔光标
- 按住鼠标左键绘制红色标注线
- Ctrl+Z 或点击 [撤销] 回退上一笔
- 鼠标移出预览区域，预览窗口关闭
```

### 交互流程

1. 鼠标移入缩略图 → 显示预览窗口
2. 在预览图上按住左键绘制 → 实时显示笔画
3. 释放鼠标 → 笔画记录到历史栈
4. Ctrl+Z → 撤销最后一笔
5. 鼠标移出预览区域 → 关闭预览，标注已保存

## 接口设计

### AnnotationService

```csharp
public class AnnotationService
{
    // 笔画管理
    public void AddStroke(DrawingStroke stroke);
    public void Undo();
    public void ClearAll();
    public List<DrawingStroke> GetStrokes();
    
    // 合并标注到图片
    public Bitmap MergeAnnotations(Bitmap original, List<DrawingStroke> strokes);
}
```

### DrawingCanvas（绘制画布控件）

```csharp
public class DrawingCanvas : PictureBox
{
    // 属性
    public Color StrokeColor { get; set; }
    public float StrokeWidth { get; set; }
    public List<DrawingStroke> Strokes { get; set; }
    
    // 事件
    public event EventHandler<DrawingStroke> StrokeCompleted;
}
```

### PreviewForm

```csharp
public class PreviewForm : Form
{
    public Bitmap OriginalImage { get; set; }
    public List<DrawingStroke> Strokes { get; set; }
    
    // 事件
    public event EventHandler<List<DrawingStroke>> AnnotationChanged;
}
```

## 数据结构

### DrawingStroke

```csharp
public class DrawingStroke
{
    public List<Point> Points { get; set; }
    public Color Color { get; set; }
    public float Width { get; set; }
}
```

## 设计决策

1. **悬浮触发预览** — 鼠标移入缩略图显示，移出关闭
2. **笔画栈式撤销** — 每一笔作为一个整体，撤销时整笔移除
3. **红色默认画笔** — 醒目，适合标注问题
4. **标注实时保存** — 关闭预览时自动保存到条目
